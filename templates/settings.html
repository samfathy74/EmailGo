{% extends "base.html" %}

{% block content %}
<div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800 dark:text-white" data-i18n="page_settings">Settings</h2>
</div>

<div class="mb-8 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
    <p class="text-sm text-blue-800 dark:text-blue-300" data-i18n="manage_servers">Manage your email servers.</p>
</div>

<!-- Existing Servers -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
    {% for server in servers %}
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border {{ 'border-green-500 ring-1 ring-green-500' if server.is_primary else 'border-gray-100 dark:border-gray-700' }}">
        <div class="flex justify-between items-start mb-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ server.name }}</h3>
            {% if server.is_primary %}
            <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium" data-i18n="primary">Primary</span>
            {% else %}
            <a href="{{ url_for('set_primary_server', server_id=server.id) }}" class="text-xs text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300" data-i18n="make_primary">Make Primary</a>
            {% endif %}
        </div>
        <div class="space-y-2 text-sm text-gray-600 dark:text-gray-400 mb-4">
            <p><span class="font-medium" data-i18n="email_address">Email:</span> {{ server.smtp_email }}</p>
            <p><span class="font-medium" data-i18n="smtp_server">SMTP:</span> {{ server.smtp_server }}:{{ server.smtp_port }}</p>
            <p><span class="font-medium" data-i18n="imap_server">IMAP:</span> {{ server.imap_server }}</p>
        </div>
        <div class="flex justify-end space-x-2 pt-2 border-t border-gray-100 dark:border-gray-700">
            <button onclick="openEditServerModal('{{ server.id }}', '{{ server.name }}', '{{ server.smtp_server }}', '{{ server.smtp_port }}', '{{ server.smtp_email }}', '{{ server.imap_server }}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 transition-colors" title="Edit Server">
                <span class="sr-only" data-i18n="edit">Edit</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            </button>
            {% if not server.is_primary %}
            <form action="{{ url_for('delete_server', server_id=server.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this server?');" style="display:inline;">
                <button type="submit" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 transition-colors" title="Delete Server">
                    <span class="sr-only" data-i18n="delete">Delete</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    {% else %}
    <div class="col-span-full bg-yellow-50 p-4 rounded-lg text-yellow-800">
        No servers configured. Please add one below.
    </div>
    {% endfor %}
</div>

<!-- Edit Server Modal -->
<div id="editServerModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white dark:bg-gray-800">
        <div class="mt-3">
            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4" data-i18n="edit_template">Edit Server</h3>
            <form id="editServerForm" method="POST">
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="edit_server_name" data-i18n="server_name">Server Name</label>
                    <input type="text" name="name" id="edit_server_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                
                <h4 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-3 mt-6" data-i18n="smtp_config">SMTP Configuration (Sending)</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="edit_smtp_server" data-i18n="smtp_server">SMTP Server</label>
                        <input type="text" name="smtp_server" id="edit_smtp_server" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="edit_smtp_port" data-i18n="port">Port</label>
                        <input type="number" name="smtp_port" id="edit_smtp_port" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="edit_smtp_email" data-i18n="email_address">Email Address</label>
                    <input type="email" name="smtp_email" id="edit_smtp_email" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="edit_smtp_password" data-i18n="app_password">App Password</label>
                    <input type="password" name="smtp_password" id="edit_smtp_password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Leave blank to keep unchanged">
                    <p class="text-xs text-gray-500 mt-1" data-i18n="password_change_hint">Only enter if you want to change it.</p>
                </div>

                <h4 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-3" data-i18n="imap_config">IMAP Configuration (Replies)</h4>
                <div class="mb-6">
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="edit_imap_server" data-i18n="imap_server">IMAP Server</label>
                    <input type="text" name="imap_server" id="edit_imap_server" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="document.getElementById('editServerModal').classList.add('hidden')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="cancel">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700" data-i18n="save_changes">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditServerModal(id, name, smtp_server, smtp_port, smtp_email, imap_server) {
        document.getElementById('editServerForm').action = `/settings/server/${id}/edit`;
        document.getElementById('edit_server_name').value = name;
        document.getElementById('edit_smtp_server').value = smtp_server;
        document.getElementById('edit_smtp_port').value = smtp_port;
        document.getElementById('edit_smtp_email').value = smtp_email;
        document.getElementById('edit_imap_server').value = imap_server;
        document.getElementById('edit_smtp_password').value = ''; // Clear password field
        document.getElementById('editServerModal').classList.remove('hidden');
    }
</script>

<!-- Add New Server -->
<div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700 max-w-2xl">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6" data-i18n="add_new_server">Add New Server</h3>
    <form action="{{ url_for('settings') }}" method="POST">
        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="name" data-i18n="server_name">Server Name (Friendly Name)</label>
            <input type="text" name="name" id="name" placeholder="e.g. Marketing Gmail" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        
        <h4 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-3 mt-6" data-i18n="smtp_config">SMTP Configuration (Sending)</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="smtp_server" data-i18n="smtp_server">SMTP Server</label>
                <input type="text" name="smtp_server" id="smtp_server" value="smtp.gmail.com" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div>
                <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="smtp_port" data-i18n="port">Port</label>
                <input type="number" name="smtp_port" id="smtp_port" value="587" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="smtp_email" data-i18n="email_address">Email Address</label>
            <input type="email" name="smtp_email" id="smtp_email" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>
        <div class="mb-6">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="smtp_password" data-i18n="app_password">App Password</label>
            <input type="password" name="smtp_password" id="smtp_password" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            <p class="text-xs text-gray-500 mt-1" data-i18n="password_hint">Use an App Password for Gmail/Outlook, not your login password.</p>
        </div>

        <h4 class="text-md font-medium text-gray-800 dark:text-gray-200 mb-3" data-i18n="imap_config">IMAP Configuration (Replies)</h4>
        <div class="mb-6">
            <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" for="imap_server" data-i18n="imap_server">IMAP Server</label>
            <input type="text" name="imap_server" id="imap_server" value="imap.gmail.com" required class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 dark:text-gray-200 dark:bg-gray-700 leading-tight focus:outline-none focus:shadow-outline">
        </div>

        <div class="flex justify-end">
            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors" data-i18n="add_server">Add Server</button>
        </div>
    </form>
</div>
{% endblock %}
